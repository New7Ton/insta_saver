<html>
<head>
	<meta charset="utf-8">
	<!script src=FileSaver.js></script>
	<!script src=myTestScript.js></script>

	<link rel="stylesheet" type="text/css" href="elastislide/css/demo.css" />
	<link rel="stylesheet" type="text/css" href="elastislide/css/elastislide.css" />
	<link rel="stylesheet" type="text/css" href="elastislide/css/custom.css" />
	
	<script src="elastislide/js/jquery-1.8.2.min.js"></script>
	<script src="elastislide/js/modernizr.custom.17475.js"></script>
	<script src="elastislide/js/jquerypp.custom.js"></script>
	<script src="elastislide/js/jquery.elastislide.js"></script>
	<script src="FileSaver.js"></script>
	<script src="https://vk.com/js/api/xd_connection.js?2"  type="text/javascript"></script>

	<style type='text/css'>
	html { overflow:  hidden; }
	
	#box img 
	{
		display: block;
		width: 200px; 
		background: white;
		padding: 1px;
		padding-right: 10px; 
		border: solid 1px white; 
		float: left;
	}
	
	#loadBox 
	{
		position: absolute; /* Абсолютное позиционирование */
		top: 250px;
		left: 230px;
	}
	
	#inputBox 
	{
		position: absolute; /* Абсолютное позиционирование */
		top: 230px;
		margin: 0 auto;
	}
	
	body 
	{
		background: white;
		background-color: white;
	}
	</style>
</head>

<body>
	<form>
	<div id = "inputBox">
		<input name="url" type="text" required size="60" placeholder="Ссылка на фотосет пользователя instagram">
		<input type="button" onclick="ProcessButtonClick(this.form)" value="Получить фото">
		<input type="button" onclick="SaveSelectedImages()" value="Сохранить"> 
		<input type="button" onclick="SaveSelectedImagesInVk()" value="Сохранить ВК"> 
	</div>
	</form>
 
	<div id='loadBox'> </div>
	
	<div class="container demo-4">
			<!-- Codrops top bar -->
            <div class="main">
				<div class="gallery">
				</div>

			</div>
	</div>
	
  
	<script>
	var SIZE_PREVIEW_IMAGE_IN_PX = 90;
	var SIZE_CURRENT_IMAGE_IN_PX = 300;
	
	var ShiftFormCompleted = false;
	var ImagesShown = false;
	var RefArray = new Array();
	var TotalNumLoadedImages = 0;
	var preview = null;
	var carouselItems = null;
	var ArrayUrlsSelectedImages = new Array();
	var VkSuccessInit = false;
	var AlbumName = "InstaSaver";
	var AlbumId = null;
	var UrlUploadServer = null;
	var ImagesFormData = new FormData();
	var ImageBlob = null;
	var LoadWasOnce = false;

	var UrlStr = document.location.href;
	var UrlParams = UrlStr.replace('?','').split('&').reduce(
        function(p,e){
            var a = e.split('=');
            p[ decodeURIComponent(a[0])] = decodeURIComponent(a[1]);
            return p;
        },
        {}
    );

	window.onload = function ()
	{
		VK.init(function() { 
		//	VK.callMethod("setTitle", "InstaSaver");
		//	VK.callMethod("showInstallBox");
			VK.callMethod("showSettingsBox", 4);
			VkSuccessInit = true;
			
		  }, function() { 
		  
			VkSuccessInit = false;
			 // API initialization failed 
			 // Can reload page here 
		}, '5.80'); 
	}
	
	function SaveSelectedImagesInVk()
	{
		AlbumId = null;
		UrlUploadServer = null;
		
		GetAppAlbumId();
		CheckAndCreateAlbum();
		GetServerForLoadPhoto();
		UploadSelectedImages();
	}
	
	function UploadSelectedImages ()
	{
		if( UrlUploadServer != null )
		{	
			for (var nImageUrl = 0; nImageUrl < ArrayUrlsSelectedImages.length; nImageUrl++ )
			{	
				UploadPhoto(ArrayUrlsSelectedImages[nImageUrl]);
			}
		}
		else
		{
			setTimeout(UploadSelectedImages, "1");
		}
	}
	
	function GetAppAlbumId()
	{
		if (VkSuccessInit)
		{	
			$.ajax({
			  url: 'https://api.vk.com/method/photos.getAlbums?',
			  data: {
				owner_id: UrlParams["viewer_id"],
				v: 5.80,
				access_token: UrlParams["access_token"]
			  },
			  type: 'GET',
			  dataType: 'jsonp',
			  success: function(data) 
			  {
				var totalNumAlbums = data.response.count;
				var albumsArray = data.response.items;
				
				for (var i = 0; i < totalNumAlbums; i++)
				{
					if ( AlbumName == albumsArray[i]["title"] )
					{
						AlbumId = albumsArray[i]["id"];
					}
				}
				
				if (AlbumId == null)
				{
					AlbumId = -1;
				}
			}})
		}
		else
		{
			setTimeout(GetAppAlbumId, "1");
		}
	}
	
	function CheckAndCreateAlbum()
	{
		if (AlbumId != null)
		{
			if (AlbumId == -1)
			{
				CreateAlbum();
			}
		}
		else
		{
			setTimeout(CheckAndCreateAlbum, "1");
		}
	}
	
	function GetServerForLoadPhoto()
	{
		if ( (AlbumId != null) && (AlbumId != -1) )
		{
			$.ajax({
			  url: 'https://api.vk.com/method/photos.getUploadServer?',
			  data: {
				album_id: AlbumId,
				v: 5.80,
				access_token: UrlParams["access_token"]
			  },
			  type: 'GET',
			  dataType: 'jsonp',
			  success: function(data) {
				UrlUploadServer = data.response.upload_url;
			}})
		}
		else
		{
			setTimeout(GetServerForLoadPhoto, "1");
		}
	}
	
	function UploadPhoto( photoUrl)
	{		
		var encodeUri = encodeURIComponent(UrlUploadServer);
		var someObj = {url:encodeUri, photo:photoUrl};
		var xhr = new XMLHttpRequest();			
		xhr.open('POST', 'scratch.php');
		xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');			
		xhr.send('param=' + JSON.stringify(someObj));
		xhr.onreadystatechange = function()
		{
		  if (this.readyState == 4) 
		  {
			if (this.status == 200)
			{
			  console.log(xhr.responseText);
			  
			  var jsonResp = JSON.parse(xhr.responseText);
			  
				$.ajax({
				url: 'https://api.vk.com/method/photos.save?',
				data: {
					server: jsonResp["server"],
					photos_list: jsonResp["photos_list"],
					album_id: jsonResp["aid"],
					hash: jsonResp["hash"],
					v: 5.80,
					access_token: UrlParams["access_token"]
				},
				type: 'GET',
				dataType: 'jsonp',
				success: function(data) 
				{
					var success = null;
				}})
			}
			else
			{
			  console.log('ajax error');
			}
		  }
		};
	}
		
	function CreateAlbum()
	{			
		$.ajax({
		  url: 'https://api.vk.com/method/photos.createAlbum?',
		  data: {
			title: AlbumName,
			v: 5.80,
			access_token: UrlParams["access_token"]
		  },
		  type: 'GET',
		  dataType: 'jsonp',
		  success: function(data) 
		  {
			AlbumId = data.response.id;
		}})
	}
	
	function SaveImage (imgUrl)
	{
		var xhr = new XMLHttpRequest();

		xhr.responseType = 'blob'; //Set the response type to blob so xhr.response returns a blob
		xhr.open('GET', imgUrl , true);

		xhr.onreadystatechange = function () 
		{
			if (xhr.readyState == xhr.DONE) 
			{
				var fileName = GetFileNameFromUrl(xhr.responseURL);
				saveAs(xhr.response, fileName);
			}
		};

		xhr.send(); //Request is sent

	}
	
	function GetImageBlob (imgUrl)
	{
		var xhr = new XMLHttpRequest();

		xhr.responseType = 'arraybuffer'; //Set the response type to blob so xhr.response returns a blob
		xhr.open('GET', imgUrl , true);

		xhr.onreadystatechange = function () 
		{
			if (xhr.readyState == xhr.DONE) 
			{
				ImageBlob = new Blob([xhr.response], {type: "image/png"});
			}
		};

		xhr.send(); //Request is sent

	}
	
	function GetFileNameFromUrl(Url)
	{		
		var urlStr = Url;
		var massSubStringsUrl = urlStr.split("/");
		var fileName = massSubStringsUrl[massSubStringsUrl.length - 1];
		
		return fileName;
	}
	
	function SaveSelectedImages()
	{
		for (var i = 0; i < ArrayUrlsSelectedImages.length; i++)
		{
			SaveImage( ArrayUrlsSelectedImages[i] );
		}
	}
	
	function Reset()
	{
		ImagesShown = false;
		TotalNumLoadedImages = 0;
		RefArray.length = 0;
		//DeleteAllImagesFromDiv("carousel");
		DeleteAllImagesFromDiv("loadBox");
	}
	
	function ProcessButtonClick(form)
	{
		if (LoadWasOnce == false)
		{
			ShiftForm(form);
			
			LoadWasOnce = true;
		}
		else
		{	
			$( ".elastislide-wrapper.elastislide-horizontal" ).remove();
			$( ".elastislide-carousel" ).remove();
			$( ".image-preview" ).remove();
		}
		
		gallaryEl = document.getElementsByClassName('gallery' );
		
		var ulCarousel = document.createElement('ul');
        ulCarousel.setAttribute('id','carousel');
        ulCarousel.setAttribute('class','elastislide-list');
		gallaryEl[0].appendChild(ulCarousel);
		
		var divPreview = document.createElement('div');
        divPreview.setAttribute('id','firstImage');
        divPreview.setAttribute('class','image-preview');
		gallaryEl[0].appendChild(divPreview);
		
		Reset();
		AddLoadImage();
		UpdateImageViewer();
		ProcessUrl(form);
		ShowImages();
	}

	function changeImage( el, pos ) 
	{
		preview.attr( 'src', el.data( 'preview' ) );
		carouselItems.removeClass( 'current-img' );
		el.addClass( 'current-img' );
		carousel.setCurrent( pos );
	}
	
	function UpdateImageViewer()
	{	
		if ( ImagesShown )
		{							
			// example how to integrate with a previewer
			var current = 0;
			preview = $( '#preview' );
			$carouselEl = $( '#carousel' );
			carouselItems = $carouselEl.children();
			carousel = $carouselEl.elastislide( 
				{
					current : current,
					minItems : 4,
					onClick : function( el, pos, evt ) 
					{
						
						var checkFlag = CheckClickArea(evt.srcElement.width, evt.srcElement.height, evt.offsetX, evt.offsetY);
						if (checkFlag)
						{
							if ( ArrayUrlsSelectedImages.indexOf(evt.srcElement.src) == -1)
							{
								ArrayUrlsSelectedImages.push(evt.srcElement.src);
							}
							else
							{
								ArrayUrlsSelectedImages.pop(evt.srcElement.src);
							}
						}
						else
						{
							changeImage( el, pos );
							evt.preventDefault();
						}
						
					},
					onReady : function() 
					{
						changeImage( carouselItems.eq( current ), current );
					}
				} );
		}
		else
		{
			setTimeout(UpdateImageViewer, "1");
		}
	}
	
	function CheckClickArea(width, height, offsetX, offsetY)
	{
		var areaInPx = 20;
		var validArea = false;
		
		if ( ((width - offsetX) < areaInPx) && ((height - offsetY) < areaInPx) )
		{
			validArea = true;
		}
		else
		{
			validArea = false;
		}
		
		return validArea;
	}
	
	function ShowImages()
	{
		if ( ShiftFormCompleted && (RefArray.length != 0) && (TotalNumLoadedImages == RefArray.length) )
		{	
			DeleteAllImagesFromDiv("loadBox");
		
			for (var i = 0; i < RefArray.length; i++)
			{
				document.getElementById("carousel").appendChild(RefArray[i]);
				
				if (i == 0)
				{
					var imgObj = new Image();
					imgObj.src = RefArray[i].firstChild.firstChild.src;
					imgObj.setAttribute("id", "preview");
					imgObj.style.width = SIZE_CURRENT_IMAGE_IN_PX + "px";
					document.getElementById("firstImage").appendChild(imgObj);
				}
			}
	
			ImagesShown = true;
		}
		else
		{
			setTimeout(ShowImages, "1");
		}
	}
	
	function AddLoadImage()
	{
		if ( ShiftFormCompleted )
		{			
			var imgObj = new Image();
			imgObj.src = "2.gif";
			document.getElementById("loadBox").appendChild(imgObj);
		}
		else
		{
			setTimeout(AddLoadImage, "1");
		}
	}
	
    function ShiftForm(form) 
	{
		var inputElems = document.getElementById('inputBox');
		
		var curTopVal = getComputedStyle(inputElems).top;
		var curTopValInt = parseInt(curTopVal);
		
		if( curTopValInt > 10 )
		{
			curTopValInt -= 3;
			inputElems.style.top = (curTopValInt + "px");
			setTimeout(ShiftForm, "1");
		}
		else if ( curTopValInt < 140 )
		{
			ShiftFormCompleted = true;
		}
    }
	
    function ProcessUrl(form) 
	{
		var url = form.elements.url.value;
		GetSiteData(url);
    }
	
	function GetSiteData(url)
	{
		var XHR = ("onload" in new XMLHttpRequest()) ? XMLHttpRequest : XDomainRequest;

		var xhr = new XHR();

		xhr.open("GET", url, true);

		xhr.onload = function() 
		{
		  ParseSiteInfo( this.responseText );
		}

		xhr.onerror = function() 
		{
		  alert( 'Ошибка ' + this.status );
		}

		xhr.send();
	}
	
	function ParseSiteInfo( srcSiteInfo )
	{
		var targetStartPos = "display_url";
		var targetFinishPos = "display_resources";
		
		var curPos = 0;
		var curStartPos = 0;
		var curFinishPos = 0;
		
		var cntTotalNumImgs = 0;
		
		var offsetStartPos = 14;
		var offsetFinishPos = 3;
		
		while (true) 	
		{
			curStartPos = srcSiteInfo.indexOf(targetStartPos, curPos);
			curPos = curStartPos + 1; 
			
			if (curStartPos == -1) 
			{
				break;
			}
			
			cntTotalNumImgs++;
			if (cntTotalNumImgs == 2)
			{
				continue;
			}
				
			curFinishPos = srcSiteInfo.indexOf(targetFinishPos, curStartPos);
			
			var finalStartPosString = curStartPos + offsetStartPos;
			var finalFinishPosString = curFinishPos - offsetFinishPos;
			
			var urlCurImgInSet = srcSiteInfo.substring( finalStartPosString, finalFinishPosString );
			
			AddImage( urlCurImgInSet );
		}
	}
	
	function AddImage( imgUrl )
	{
		var imgObj = new Image();
		imgObj.onload = function(){ TotalNumLoadedImages++; }
		imgObj.src = imgUrl;
		imgObj.style.width = SIZE_PREVIEW_IMAGE_IN_PX + "px";
		
		var newlink = document.createElement('a');
		newlink.setAttribute('href', "#");
		newlink.appendChild(imgObj);
		
		var newLi = document.createElement('li');
		newLi.setAttribute('data-preview', imgUrl);
		newLi.appendChild(newlink);
		
		RefArray.push(newLi);
	}
	
	function DeleteAllImagesFromDiv(divName)
	{
		var imgSet = document.getElementById(divName);
		
		while(imgSet.firstChild) 
		{
			imgSet.removeChild(imgSet.firstChild);
		}
	}
	
	

	
  </script>
</body>

</html>